<h2>æ·±åº¦çº¹ç†</h2>

<p>åœ¨ä¹‹å‰çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å„ç§çº¹ç†çš„ç”¨é€”ã€‚ä»Šå¤©è¦ä»‹ç»çš„<strong>æ·±åº¦çº¹ç†</strong>ï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šè€Œå¼ºå¤§çš„å·¥å…·ï¼Œå®ƒè®°å½•äº†åœºæ™¯ä¸­æ¯ä¸ªåƒç´ "æœ‰å¤šè¿œ"ã€‚</p>

<h3>ä»€ä¹ˆæ˜¯æ·±åº¦çº¹ç†ï¼Ÿ</h3>

<p>æ·±åº¦çº¹ç†å­˜å‚¨çš„æ˜¯åœºæ™¯ä¸­æ¯ä¸ªåƒç´ åˆ°æ‘„åƒæœºçš„è·ç¦»ä¿¡æ¯ã€‚</p>

<blockquote>
<p>æƒ³è±¡ä½ ç«™åœ¨ä¸€ä¸ªæˆ¿é—´é‡Œï¼Œç”¨æ¿€å…‰æµ‹è·ä»ªå¯¹ç€æ¯ä¸ªæ–¹å‘æµ‹é‡è·ç¦»ï¼Œç„¶åæŠŠè¿™äº›è·ç¦»æ•°æ®ç”»æˆä¸€å¼ ç°åº¦å›¾â€”â€”è¿‘çš„åœ°æ–¹äº®ï¼Œè¿œçš„åœ°æ–¹æš—ã€‚è¿™å°±æ˜¯æ·±åº¦çº¹ç†ï¼</p>
</blockquote>

<h3>ğŸ® åŠ¨æ‰‹è¯•è¯•ï¼šæ·±åº¦çº¹ç†é•¿å•¥æ ·</h3>

<p>å·¦è¾¹æ˜¯å½©è‰²æ¸²æŸ“çš„ç«‹æ–¹ä½“ï¼Œå³è¾¹æ˜¯å¯¹åº”çš„æ·±åº¦çº¹ç†ã€‚æŠŠé¼ æ ‡ç§»åˆ°æ·±åº¦çº¹ç†ä¸Šï¼Œçœ‹çœ‹æ¯ä¸ªåƒç´ çš„æ·±åº¦å€¼ï¼š</p>

<div class="interactive-demo" id="depth-demo" data-demo="depth">
  <canvas id="depthCanvas" width="300" height="200"></canvas>
  <div class="demo-controls">
    <div class="button-row">
      <label class="toggle-label">
        <input type="checkbox" id="depthAutoRotate" checked>
        <span>è‡ªåŠ¨æ—‹è½¬</span>
      </label>
    </div>
    <div class="control-group">
      <label>æ‰‹åŠ¨æ—‹è½¬ï¼š<span id="depthRotationValue">0Â°</span></label>
      <input type="range" id="depthRotation" min="0" max="360" value="0">
    </div>
  </div>
</div>

<blockquote>
  <p>ğŸ’¡ <strong>è§‚å¯Ÿè¦ç‚¹</strong>ï¼š</p>
  <ul>
    <li>æ·±åº¦çº¹ç†æ˜¯<strong>ç°åº¦å›¾</strong>ï¼šç™½è‰²=è¿‘ï¼Œé»‘è‰²=è¿œ</li>
    <li>ç«‹æ–¹ä½“<strong>é è¿‘ç›¸æœºçš„é¢</strong>æ›´äº®</li>
    <li>é¼ æ ‡æ‚¬åœå¯ä»¥çœ‹åˆ°<strong>ç²¾ç¡®çš„æ·±åº¦å€¼</strong>å’Œ<strong>è·ç¦»</strong></li>
    <li>æ·±åº¦å€¼èŒƒå›´æ˜¯0-1ï¼Œå¯¹åº”è¿‘è£å‰ªé¢åˆ°è¿œè£å‰ªé¢</li>
  </ul>
</blockquote>

<pre><code class="language-javascript">// æ·±åº¦çº¹ç†çš„æ¦‚å¿µ
const depthTexture = {
  width: screenWidth,
  height: screenHeight,
  // æ¯ä¸ªåƒç´ å­˜å‚¨ä¸€ä¸ªæ·±åº¦å€¼ï¼ˆ0-1ï¼‰
  // 0 = æœ€è¿‘ï¼ˆåœ¨è¿‘è£å‰ªé¢ï¼‰
  // 1 = æœ€è¿œï¼ˆåœ¨è¿œè£å‰ªé¢ï¼‰
  data: new Float32Array(screenWidth * screenHeight)
};

// æ·±åº¦å€¼çš„è®¡ç®—
function calculateDepth(worldPosition, camera) {
  const viewPos = camera.viewMatrix.transform(worldPosition);
  const depth = (viewPos.z - camera.near) / (camera.far - camera.near);
  return clamp(depth, 0, 1);
}</code></pre>

<h3>æ·±åº¦çº¹ç†çš„ç”¨é€”ä¸€ï¼šRaycastæ¢æµ‹</h3>

<p>æ·±åº¦çº¹ç†æœ€é‡è¦çš„ç”¨é€”ä¹‹ä¸€æ˜¯<strong>å±å¹•ç©ºé—´çš„å°„çº¿æ£€æµ‹</strong>ã€‚</p>


<blockquote>
<p>ä¼ ç»Ÿçš„Raycastéœ€è¦å’Œåœºæ™¯ä¸­çš„æ¯ä¸ªä¸‰è§’å½¢åšç¢°æ’æ£€æµ‹ï¼Œéå¸¸è€—æ—¶ã€‚ä½†æœ‰äº†æ·±åº¦çº¹ç†ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥"è¯»å–"æŸä¸ªæ–¹å‘ä¸Šæœ€è¿‘ç‰©ä½“çš„è·ç¦»ï¼Œå°±åƒä½œå¼Šä¸€æ ·å¿«ï¼</p>
</blockquote>

<pre><code class="language-javascript">// ä½¿ç”¨æ·±åº¦çº¹ç†è¿›è¡Œå¿«é€ŸRaycast
function screenSpaceRaycast(screenX, screenY, depthTexture, camera) {
  // ä»æ·±åº¦çº¹ç†è¯»å–æ·±åº¦å€¼
  const depth = depthTexture.sample(screenX, screenY);
  
  // å°†å±å¹•åæ ‡å’Œæ·±åº¦è½¬æ¢å›ä¸–ç•Œåæ ‡
  const clipPos = {
    x: (screenX / screenWidth) * 2 - 1,
    y: (screenY / screenHeight) * 2 - 1,
    z: depth * 2 - 1,
    w: 1
  };
  
  // é€†æŠ•å½±å˜æ¢
  const worldPos = camera.inverseViewProjection.transform(clipPos);
  worldPos.divideByW();
  
  return {
    hit: depth < 1.0,  // æ·±åº¦ä¸º1è¡¨ç¤ºæ²¡æœ‰å‡»ä¸­ä»»ä½•ç‰©ä½“
    position: worldPos,
    distance: calculateDistance(camera.position, worldPos)
  };
}

// åº”ç”¨ï¼šç‚¹å‡»å±å¹•è·å–3Dä½ç½®
canvas.onclick = (e) => {
  const result = screenSpaceRaycast(e.clientX, e.clientY, depthTex, camera);
  if (result.hit) {
    console.log('ç‚¹å‡»ä½ç½®:', result.position);
  }
};</code></pre>

<h3>æ·±åº¦çº¹ç†çš„ç”¨é€”äºŒï¼šè½¯é˜´å½±</h3>

<p>æ·±åº¦çº¹ç†æ˜¯å®ç°é˜´å½±çš„åŸºç¡€ã€‚é€šè¿‡ä»å…‰æºè§†è§’æ¸²æŸ“æ·±åº¦çº¹ç†ï¼ˆç§°ä¸ºShadow Mapï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­å“ªäº›åŒºåŸŸåœ¨é˜´å½±ä¸­ã€‚</p>

<pre><code class="language-glsl">// é˜´å½±è®¡ç®—çš„ç‰‡æ®µç€è‰²å™¨
uniform sampler2D shadowMap;
uniform mat4 lightViewProjection;

float calculateShadow(vec3 worldPos) {
  // å°†ä¸–ç•Œåæ ‡è½¬æ¢åˆ°å…‰æºç©ºé—´
  vec4 lightSpacePos = lightViewProjection * vec4(worldPos, 1.0);
  lightSpacePos.xyz /= lightSpacePos.w;
  
  // è½¬æ¢åˆ°0-1èŒƒå›´
  vec2 shadowUV = lightSpacePos.xy * 0.5 + 0.5;
  
  // ä»é˜´å½±è´´å›¾é‡‡æ ·æ·±åº¦
  float shadowDepth = texture2D(shadowMap, shadowUV).r;
  float currentDepth = lightSpacePos.z * 0.5 + 0.5;
  
  // æ¯”è¾ƒæ·±åº¦ï¼šå¦‚æœå½“å‰æ·±åº¦å¤§äºé˜´å½±è´´å›¾æ·±åº¦ï¼Œè¯´æ˜åœ¨é˜´å½±ä¸­
  float shadow = currentDepth > shadowDepth + 0.001 ? 0.5 : 1.0;
  
  return shadow;
}</code></pre>


<h3>æ·±åº¦çº¹ç†çš„ç”¨é€”ä¸‰ï¼šæ™¯æ·±æ•ˆæœ</h3>

<p>ç”µå½±ä¸­å¸¸è§çš„æ™¯æ·±æ•ˆæœï¼ˆç„¦ç‚¹æ¸…æ™°ï¼Œå‰åæ¨¡ç³Šï¼‰ä¹Ÿä¾èµ–æ·±åº¦çº¹ç†ï¼š</p>

<pre><code class="language-glsl">// æ™¯æ·±æ•ˆæœ
uniform sampler2D colorTexture;
uniform sampler2D depthTexture;
uniform float focusDistance;  // ç„¦ç‚¹è·ç¦»
uniform float focusRange;     // ç„¦ç‚¹èŒƒå›´

vec4 depthOfField(vec2 uv) {
  float depth = texture2D(depthTexture, uv).r;
  
  // è®¡ç®—æ¨¡ç³Šç¨‹åº¦ï¼šç¦»ç„¦ç‚¹è¶Šè¿œè¶Šæ¨¡ç³Š
  float blur = abs(depth - focusDistance) / focusRange;
  blur = clamp(blur, 0.0, 1.0);
  
  // æ ¹æ®æ¨¡ç³Šç¨‹åº¦é‡‡æ ·
  vec4 sharpColor = texture2D(colorTexture, uv);
  vec4 blurredColor = gaussianBlur(colorTexture, uv, blur * 10.0);
  
  return mix(sharpColor, blurredColor, blur);
}</code></pre>

<h3>æ·±åº¦çº¹ç†çš„ç”¨é€”å››ï¼šå±å¹•ç©ºé—´æ•ˆæœ</h3>

<p>å¾ˆå¤šé«˜çº§æ•ˆæœéƒ½éœ€è¦æ·±åº¦ä¿¡æ¯ï¼š</p>

<ul>
  <li><strong>SSAOï¼ˆå±å¹•ç©ºé—´ç¯å¢ƒå…‰é®è”½ï¼‰</strong>ï¼šè®©è§’è½å’Œç¼éš™æ›´æš—</li>
  <li><strong>SSRï¼ˆå±å¹•ç©ºé—´åå°„ï¼‰</strong>ï¼šå®æ—¶åå°„æ•ˆæœ</li>
  <li><strong>ä½“ç§¯å…‰</strong>ï¼šå…‰çº¿ç©¿è¿‡çƒŸé›¾çš„æ•ˆæœ</li>
  <li><strong>è¾¹ç¼˜æ£€æµ‹</strong>ï¼šæè¾¹æ•ˆæœ</li>
</ul>

<pre><code class="language-javascript">// ä½¿ç”¨æ·±åº¦è¿›è¡Œè¾¹ç¼˜æ£€æµ‹
function edgeDetection(depthTexture, uv) {
  const center = depthTexture.sample(uv);
  const left = depthTexture.sample(uv.x - 1, uv.y);
  const right = depthTexture.sample(uv.x + 1, uv.y);
  const up = depthTexture.sample(uv.x, uv.y - 1);
  const down = depthTexture.sample(uv.x, uv.y + 1);
  
  // æ·±åº¦å·®å¼‚å¤§çš„åœ°æ–¹å°±æ˜¯è¾¹ç¼˜
  const edge = Math.abs(center - left) + Math.abs(center - right) +
               Math.abs(center - up) + Math.abs(center - down);
  
  return edge > threshold ? 1 : 0;
}</code></pre>

<h3>å¦‚ä½•è·å–æ·±åº¦çº¹ç†</h3>

<p>åœ¨ä¸åŒçš„å›¾å½¢APIä¸­è·å–æ·±åº¦çº¹ç†çš„æ–¹å¼ç•¥æœ‰ä¸åŒï¼š</p>

<pre><code class="language-javascript">// WebGLä¸­åˆ›å»ºæ·±åº¦çº¹ç†
function createDepthTexture(gl, width, height) {
  const depthTexture = gl.createTexture();
  gl.bindTexture(gl.TEXTURE_2D, depthTexture);
  
  gl.texImage2D(
    gl.TEXTURE_2D, 0, gl.DEPTH_COMPONENT24,
    width, height, 0,
    gl.DEPTH_COMPONENT, gl.UNSIGNED_INT, null
  );
  
  // è®¾ç½®é‡‡æ ·å‚æ•°
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
  
  return depthTexture;
}

// ç»‘å®šåˆ°å¸§ç¼“å†²
gl.framebufferTexture2D(
  gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT,
  gl.TEXTURE_2D, depthTexture, 0
);</code></pre>

<h3>å°ç»“</h3>

<p>åœ¨è¿™ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å­¦åˆ°äº†ï¼š</p>

<ol>
  <li>æ·±åº¦çº¹ç†å­˜å‚¨æ¯ä¸ªåƒç´ åˆ°æ‘„åƒæœºçš„è·ç¦»</li>
  <li>å¯ä»¥ç”¨äºå¿«é€Ÿçš„å±å¹•ç©ºé—´Raycast</li>
  <li>æ˜¯å®ç°é˜´å½±çš„åŸºç¡€ï¼ˆShadow Mapï¼‰</li>
  <li>ç”¨äºæ™¯æ·±ã€SSAOã€SSRç­‰é«˜çº§æ•ˆæœ</li>
  <li>æ˜¯ç°ä»£æ¸²æŸ“ä¸­ä¸å¯æˆ–ç¼ºçš„å·¥å…·</li>
</ol>

<p>æ·±åº¦çº¹ç†æ˜¯è¿æ¥2Då±å¹•å’Œ3Dä¸–ç•Œçš„æ¡¥æ¢ï¼ŒæŒæ¡å®ƒèƒ½è®©ä½ å®ç°å¾ˆå¤šç‚«é…·çš„æ•ˆæœã€‚è‡³æ­¤ï¼Œè¿›é˜¶æ¦‚å¿µç¯‡å°±ç»“æŸäº†ï¼æ¥ä¸‹æ¥çš„æ•°å­¦ç¯‡ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨å›¾å½¢å­¦èƒŒåçš„æ•°å­¦åŸç†ï¼Œä»<strong>çŸ©é˜µçš„ç”¨é€”</strong>å¼€å§‹ï¼</p>
